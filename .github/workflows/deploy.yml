name: Deploy

on:
  workflow_dispatch:
    inputs:
      environment:
        type: choice
        required: true
        options: [staging, production]
      image_tag:
        required: true
        type: string
        default: latest
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - run: |
          APPS=$(bash scripts/affected-apps.sh)
          echo "apps=$APPS" >> "$GITHUB_OUTPUT"
        id: affected
      - name: Deploy changed apps
        if: steps.affected.outputs.apps != '[]'
        env:
          DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
          DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
          IMAGE_TAG: ${{ github.event.inputs.image_tag || 'latest' }}
        run: |
          echo '${{ steps.affected.outputs.apps }}' | jq -r '.[]' | while read -r app; do
            bash scripts/deploy-site.sh "$app" "$IMAGE_TAG"
          done
